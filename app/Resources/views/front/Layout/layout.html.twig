{% set current_url = '%s://%s%s'|format(app.request.scheme, app.request.host, app.request.requestUri) %}
{% set is_register_page = is_register_page|default(false) %}
{% set cookiebar = true %}

{% set isLogged = is_granted('IS_AUTHENTICATED_FULLY') %}
{% set isUserPro = (isLogged and app.user.isPro) %}
{% set isUserPersonal = (isLogged and app.user.isPersonal) %}
{% set isUserAdmin = is_granted('ROLE_ADMIN') %}

<!DOCTYPE html>
<html lang="{{ app.request.locale|slice(0, 2) }}" prefix="og: http://ogp.me/ns#">
<head>
    {% if google_tag_manager_id is not empty %}
        <!-- Google Tag Manager -->
        <script>(function (w, d, s, l, i) {
            w[l] = w[l] || [];
                {# Définir l'ID utilisateur à partir du paramètre user_id de l'utilisateur connecté. #}
                {% if isLogged %}
            w[l].push({'userId': "{{ isUserPro ? 'pro':'personal' }}_{{ app.user.id }}", event: 'gtm.js'});
                {% endif %}
            w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
            let f = d.getElementsByTagName(s)[0], j = d.createElement(s), dl = (l !== 'dataLayer' ? '&l=' + l : '');
            j.async = true;
            j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
            f.parentNode.insertBefore(j, f);
          })(window, document, 'script', 'dataLayer', '{{ google_tag_manager_id }}');

        </script>
        <!-- End Google Tag Manager -->
    {% endif %}

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{% block title %}{% endblock %} - {{ site_name }}</title>

    <meta name="description" content="{% block meta_description %}{% endblock %}">

    {# ogp.me : required properties #}
    <meta property="og:title" content="{{ block('title') }}">
    <meta property="og:type" content="{% block og_type %}website{% endblock %}">
    {% block seo_img_block %}<meta property="og:image" content="{{ seo_img_url|default( absolute_url(asset('assets/images/background/reprise-et-achat-auto-par-affinites-small-bg-white.png'))) }}">{% endblock %}
    <meta property="og:url" content="{{ current_url }}">
    {# ogp.me : optional metadatas #}
    <meta property="og:locale" content="{{ app.request.locale~'_'~app.request.locale|upper }}">
    <meta property="og:site_name" content="{{ site_name }}">
    <meta property="og:description" content="{{ block('meta_description') }}">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ block('title') }}">
    <meta name="twitter:description" content="{{ block('meta_description') }}">
    <meta name="twitter:image" content="{{ seo_img_url|default( absolute_url(asset('assets/images/background/reprise-et-achat-auto-par-affinites-small-bg-white.png'))) }}">
    <meta name="twitter:image:alt" content="{{ image_alt|default(block('title')) }}">
    <meta name="twitter:url" content="{{ current_url }}">
    <meta name="twitter:site" content="@{{ twitter_username }}">
    <meta name="twitter:creator" content="@{{ twitter_username }}">

    <meta property="fb:pages" content="{{ facebook_page_id }}">
    {% for admin_id in facebook_admin_ids|split(',') %}
        <meta property="fb:admins" content="{{ admin_id }}">
    {% endfor %}
    <meta property="fb:app_id" content="{{ facebook_app_id }}">

    {# Turning off Number Detection in iOS #}
    <meta name="format-detection" content="telephone=no">

    {% block additional_meta %}{% endblock %}

    <link rel="apple-touch-icon" sizes="180x180" href="{{ asset('assets/images/favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ asset('assets/images/favicons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ asset('assets/images/favicons/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ asset('assets/images/favicons/manifest.json') }}">
    <link rel="mask-icon" href="{{ asset('assets/images/favicons/safari-pinned-tab.svg') }}" color="#000000">
    <link rel="shortcut icon" href="{{ asset('assets/images/favicons/favicon.ico') }}">
    <meta name="msapplication-config" content="{{ asset('assets/images/favicons/browserconfig.xml') }}">
    <meta name="theme-color" content="#ffffff">

    <link rel="canonical" href="{% block canonical %}{{ current_url }}{% endblock canonical %}">

    {% if seo_noindex is defined %}
        <meta name="robots" content="noindex, nofollow">
    {% endif %}

     <link rel="stylesheet" href="{{ asset('assets/bundle/bundle.css') }}?v={{ site_version }}">
</head>
{% if app.environment == 'inte' %}
    <body id="js-body" data-toggler=".debug">
        <style>{% include 'front/Layout/css/debug.css' %}</style>
        {% include 'front/Layout/includes/debug.html.twig' %}
{% else %}
    <body class="{% block bodyClass %}{% endblock %}">
{% endif %}
    {% if google_tag_manager_id is not empty %}
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ google_tag_manager_id }}"
                          height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <!-- End Google Tag Manager (noscript) -->
    {% endif %}

    {% if is_register_page %}
        <div class="is-relative-for-ie is-sticky"> {# IE fix #}
            {% include 'front/Layout/includes/header_register.html.twig' %}
        </div>
    {% else %}
        {% include 'front/Layout/includes/header.html.twig' %}
    {% endif %}

    {% block flash_messages %}
        {% include ':front/Layout/includes:flashMessage.html.twig' %}
    {% endblock %}

    <main class="l-main {% block mainClass %}{% endblock %}">
        {% block body %}{% endblock %}
    </main>

    {% block footer %}
        {% include 'front/Layout/includes/footer.html.twig' %}
    {% endblock %}

    {% if cookiebar is defined and cookiebar == true %}
        {% include 'front/Layout/includes/cookie_bar.html.twig' %}
    {% endif %}

    {% block modal %}{% endblock %}

    <script src="{{ asset('assets/bundle/bundle.js') }}?v={{ site_version }}" defer async></script>
    {% block javascripts %}{% endblock %}

    </body>
</html>
